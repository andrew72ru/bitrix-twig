BITRIX/TWIG
===========

> Модуль для отображения twig-шаблонов в bitrix

## Описание

Битрикс позволяет отображать контент через сторонние движки шаблонизации, например, через [twig](https://twig.symfony.com).

Чтобы это осуществить, нужно, чтоб при инициализации был объявлен глобальный (!!!) массив примерно такой структуры:

```php
$arCustomTemplateEngines['twig'] = [
    'templateExt' => ['twig', 'html.twig'],
    'function'    => 'renderTwigTemplate'
];
```

Ключ `templateExt` должен содержать расширения файлов шаблонов, а `function` — имя глобальной (!!!) функции, которая будет вызвана при рендеринге. Функция должна выводить (да, бл… выводить, не возвращать) результат рендеринга шаблона в виде строки.

(Если вам уже плохо от всего этого, подождите, будет ещё хуже)

## Установка

Вы **должны** использовать автолоадер composer-а в своем проекте, сайт **должен** быть установлен в кодировке 'utf-8'.

Устанавливайте модуль через композер:

```
composer require andrew72ru/bitrix-twig
```

Глобальный массив и функции будут загружены с помощью автолоада.

## Конфигурация

Конфигурация по-умолчанию:

```php
'debug' => false,
'charset' => 'utf-8',
'cache' => $_SERVER['DOCUMENT_ROOT'] . '/bitrix/cache/twig',
'auto_reload' => $this->request->get('clear_cache') ? 'Y' === strtoupper($this->request->get('clear_cache')) : false,
'autoescape' => false,
```

Вы можете переопределять и дополнять эту конфигурацию в файле `bitrix/.settings.php`. Ключ массива настроек — `twigRenderer`.

Пример конфигурации:

```php
// bitrix/.settings.php

<?php

return [
    // skip
    'twigRenderer' => [
        'value' => [
            'debug' => true,
        ]
    ],
    // skip
];
```

## Использование

Положите в каталог шаблонов вашего компонента файл `<название_шаблона>.thml.twig` (или `<название_шаблона>.twig`) вместо обычного `<название_шаблона>.php`. Вся html-разметка, функции и фильтры twig будут обработаны движком twig. Модуль реализует некоторые специфические функции, необходимые для интеграции с битрикс.

### Специфические фунции и переменные

##### Глобальные переменные

- `$_SERVER` — `_SERVER`;
- `$_REQUEST` — `_REQUEST`;
- `$_GET` — `_GET`;
- `$_POST` — `_POST`;
- `$_FILES` — `_FILES`;
- `$_SESSION` — `_SESSION`;
- `$_COOKIE` — `_COOKIE`;
- `$_GLOBALS` — `_GLOBALS`

##### Доступные функции

- `showError`
- `showMessage`
- `showNote`
- `bitrix_sessid_post`
- `bitrix_sessid_get`
- `getMessage`
- `include_component`

Все эти функции вызывают соответствующие им из движка битрикс.

- `_call_static($class, $method, $arguments = [])` — позволяет вызвать статический метод любого загруженного класса.

##### Переменные шаблона

- `result` — `$arResult` в традиционном шаблоне;
- `params` — `$arParams`;
- `lang` — массив загруженных переводов;
- `template` — экземпляр класса `CBitrixComponentTemplate` (доступны все его функции);
- `templateFolder` — путь к папке шаблона;
- `parentTemplateFolder` — путь к папке родительского шаблона;

## События

Модуль вызывает единственное событие `onAfterTwigEngineInit` после собственной инициализации. Вы можете использовать это событие для добавления собственных фильтров / функций / расширений. Подробрее смотрите документацию битрикса и [Extending Twig](https://twig.symfony.com/doc/1.x/advanced.html).

## Тесты

В данный момент тесты фактически не реализованы — есть лишь один класс, который закрывает около 30% кода. Чтоб тесты (даже существующие) заработали, надо, чтоб был установлен битрикс, чтоб в этот битрикс был установлен этот модуль, и чтоб был хотя бы один шаблон, использующий рендер из этого модуля.

Внутри модуля используются классы из ядра битрикса, в частности, для того, чтобы находить правильные пути к битрикс-шаблонам, но ни автолоадера, ни сервис-контейнера, ни прочих вещей, присущих фреймворкам, в даннм случае нет. Поэтому и вызвать / загрузить / сделать mock для этих классов нельзя.

Если вдруг вы знаете, как сделать тесты, покрывающие весь код этого модуля — присылайте пулл-реквесты.
